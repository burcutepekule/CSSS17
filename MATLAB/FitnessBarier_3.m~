clear all;clc;
Cdata=[    0.9290    0.6940    0.1250;
    0.8500    0.3250    0.0980;
    0         0.4470    0.7410;
    0.4940    0.1840    0.5560;
    0.4660    0.6740    0.1880;
    0.3010    0.7450    0.9330;
    0.6350    0.0780    0.1840;
    0.9290    0.6940    0.1250];
%%% SIMULATION PARAMETERS %%%
N         = 3;
PN        = N;

kMatTemp   = zeros(N,N);
kFunc      = 10:-1:0;
kFunc      = kFunc(1:N);
for i=1:PN
    kMatTemp(i,:)=circshift(kFunc',i-1)';
end
h1 = tril(kMatTemp,-1)'+kMatTemp;
h2 = triu(kMatTemp,-1)'+kMatTemp;
mostunfitNear = tril(kMatTemp,-1)+tril(kMatTemp)';
mostfitNear   = triu(kMatTemp,1)+triu(kMatTemp)';
kMat          = mostunfitNear;

qMat            = q.*ones(N,N);
qMat(1:N+1:N*N) = 1;
qVecTemp        = qMat(:)';
qVec            = qVecTemp(qVecTemp~=1); %delete the ones, send it as a vector
% sVec  = [s1_1, s1_2, ... s1_PN, s2_1, s2_2 ... s2_PN ... sN_1, sN_2, ..., sN_PN];
% rVec  = [r1_1, r1_2, ... r1_PN, r2_1, r2_2 ... r2_PN ... rN_1, rN_2, ..., rN_PN];
% kVec  = [r1_1, r1_2, ... r1_PN, r2_1, r2_2 ... r2_PN ... rN_1, rN_2, ..., rN_PN];

sims = 1;
tspan = [0 10^30];
tol   = 10^-5*ones(1,N*PN);
y0 = 1*ones(1,N*PN); %INITIAL CONDITIONS
options = odeset('NonNegative',1:N*PN);
[t,y] = ode15s(@(t,y) odefcn_3(X,M,N,PN,K), tspan, y0,options);

numOfPts = size(y,1);
pts2consider=round(numOfPts*0.1);
yCheck = y(end:-1:end-pts2consider,:);
varIny = var(yCheck);
plot(1:numOfPts,y)
%%
if(sum(varIny<tol)==N*PN)
    X = y(end,:);
%     inputArr=num2cell([A(:)' kVec M(:)' qVec rVec sVec  X]);
%     inputArr_allZero=num2cell([A(:)' kVec M(:)' qVec rVec sVec  zeros(size(X))]);
%     fh = str2func(funcName);
%     J_out=fh(inputArr{:});
%     J_out_allZero=fh(inputArr_allZero{:});
%     eigNormal  = eig(J_out);
%     eigAllZero = eig(J_out_allZero);
    xMean=mean(X,1);
end


binK =kMatTemp==max(kFunc); %find the most fit
sz = [300,1000]; % figure size
screensize = get(0,'ScreenSize');
xpos = ceil((screensize(3)-sz(2))/2); % center the figure on the
ypos = ceil((screensize(4)-sz(1))/2); % center the figure on the
figure('position',[xpos, ypos, sz(2), sz(1)]);
for ii=1:PN
    scatter((ii-1)*N+1:(ii-1)*N+N,xMean((ii-1)*N+1:(ii-1)*N+N),30,Cdata(ii,:));
    hold on;
    [~,indxs]=find(binK(ii,:)==1);
    for ll=1:length(indxs)
        scatter((ii-1)*N+indxs(ll),xMean((ii-1)*N+indxs(ll)),30,[0 0 0],'filled');
    end
    plot([ii*PN+0.5 ii*PN+0.5],[0 10],'k--','linewidth',1)
end
axis([0 ii*PN+0.5 0 max(xMean)+0.1])
grid on;
title(num2str(sum(kMat,1)))
hold off;
%%
figure
plot(y,'linewidth',2)
h=legend('$x_1^{1}$','$x_2^{1}$','$x_3^{1}$',...
       '$x_1^{2}$','$x_2^{2}$','$x_3^{2}$',...
       '$x_1^{3}$','$x_2^{3}$','$x_3^{3}$');   
set(h,'Interpreter','latex')
grid on;

h.FontSize = 16;
